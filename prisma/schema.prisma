generator client {
  provider = "prisma-client-js"
}

// PostgreSQL for production (RDS) and local development
// DATABASE_URL is configured in prisma.config.ts
datasource db {
  provider = "postgresql"
}

/// AI development milestone entity
model Milestone {
  id                   String   @id @default(cuid())
  title                String
  description          String
  date                 DateTime
  category             String
  significance         Int
  era                  String?
  organization         String?
  contributors         String   @default("[]")
  sourceUrl            String?
  imageUrl             String?
  tags                 String   @default("[]")
  sources              String   @default("[]")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  businessImpact       String?
  commonMisconceptions String?
  historicalContext    String?
  simpleExplanation    String?
  technicalDepth       String?
  tldr                 String?
  whyItMattersToday    String?

  @@index([date])
  @@index([category])
  @@index([era])
}

/// News source for automated ingestion
model NewsSource {
  id             String            @id @default(cuid())
  name           String
  url            String            @unique
  feedUrl        String
  isActive       Boolean           @default(true)
  checkFrequency Int               @default(60)
  lastCheckedAt  DateTime?
  createdAt      DateTime          @default(now())
  articles       IngestedArticle[]
}

/// Article ingested from a news source
model IngestedArticle {
  id             String      @id @default(cuid())
  sourceId       String
  source         NewsSource  @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  externalUrl    String      @unique
  title          String
  content        String
  publishedAt    DateTime
  ingestedAt     DateTime    @default(now())

  // Stage 1 Analysis Results (Sprint 30)
  analysisStatus    String      @default("pending") // pending, screening, generating, complete, error
  analyzedAt        DateTime?
  relevanceScore    Float?      // 0-1 scale
  isMilestoneWorthy Boolean     @default(false)
  milestoneRationale String?    // Why/why not milestone-worthy
  analysisError     String?

  // Review fields (Sprint 31)
  reviewStatus   String      @default("pending")

  // Duplicate detection (Sprint 32)
  isDuplicate       Boolean   @default(false)
  duplicateOfId     String?   // Points to the "primary" article
  duplicateOf       IngestedArticle?  @relation("DuplicateOf", fields: [duplicateOfId], references: [id])
  duplicates        IngestedArticle[] @relation("DuplicateOf")
  duplicateScore    Float?    // 0-1 similarity score
  duplicateReason   String?   // "title_match" | "content_match" | "url_match"

  // Relations
  drafts         ContentDraft[]

  @@index([sourceId])
  @@index([publishedAt])
  @@index([analysisStatus])
  @@index([isMilestoneWorthy])
  @@index([isDuplicate])
  @@index([ingestedAt])
}

/// AI-generated content draft awaiting review
model ContentDraft {
  id               String           @id @default(cuid())
  articleId        String
  article          IngestedArticle  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  contentType      String           // "news_event" | "milestone" | "glossary_term"
  draftData        Json             // JSON matching target schema (native PostgreSQL JSON type)

  // Validation
  isValid          Boolean          @default(false)
  validationErrors String?          // JSON array of validation errors

  // Review status
  status           String           @default("pending") // pending, approved, rejected, published
  rejectionReason  String?

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  publishedAt      DateTime?
  publishedId      String?          // ID of published milestone/event/term

  @@index([articleId])
  @@index([contentType])
  @@index([status])
}

/// Glossary term for AI/ML vocabulary (Sprint 32)
model GlossaryTerm {
  id                  String   @id @default(cuid())
  term                String   @unique
  shortDefinition     String   // For tooltips (max 200 chars)
  fullDefinition      String   // 2-3 sentences
  businessContext     String?  // Why it matters to business professionals
  example             String?  // Real-world example
  inMeetingExample    String?  // Practical usage example
  category            String   // core_concept, technical_term, business_term, model_architecture, company_product
  relatedTermIds      String   @default("[]") // JSON array of glossary term IDs
  relatedMilestoneIds String   @default("[]") // JSON array of milestone event IDs
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  sourceArticleId     String?  // Link to ingested article if AI-generated

  @@index([term])
  @@index([category])
}

/// Pipeline error tracking (Sprint 32.11)
model IngestionError {
  id            String   @id @default(cuid())
  errorType     String   // "fetch" | "analysis" | "duplicate_detection"
  sourceId      String?  // For fetch errors, links to NewsSource
  articleId     String?  // For analysis errors, links to IngestedArticle
  message       String
  stackTrace    String?
  retryCount    Int      @default(0)
  maxRetries    Int      @default(3)
  resolved      Boolean  @default(false)
  resolvedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([errorType])
  @@index([resolved])
  @@index([createdAt])
}

/// Pipeline settings for admin controls (Sprint 32.12)
model PipelineSettings {
  id                  String   @id @default("default")
  ingestionPaused     Boolean  @default(false)
  analysisPaused      Boolean  @default(false)
  lastIngestionRun    DateTime?
  lastAnalysisRun     DateTime?
  updatedAt           DateTime @updatedAt
}

// =============================================================================
// Flashcard System (Sprint 36)
// =============================================================================

/// Flashcard for study/review system
/// Individual study cards with term and definition
model Flashcard {
  id                  String   @id @default(cuid())
  term                String
  definition          String
  category            String   // model_architecture, technical_term, core_concept, etc.
  relatedMilestoneIds String   @default("[]") // JSON array of milestone IDs
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([category])
  @@index([term])
}

/// Prebuilt flashcard deck - curated collections of cards
/// Decks can reference cards from multiple sources (milestones, glossary, custom)
model PrebuiltDeck {
  id               String            @id @default(cuid())
  name             String            @unique
  description      String
  difficulty       String            // beginner, intermediate, advanced
  cardCount        Int
  estimatedMinutes Int
  previewCardIds   String            @default("[]") // JSON array of card IDs for preview
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  cards            PrebuiltDeckCard[]

  @@index([difficulty])
}

/// Card membership in a prebuilt deck
/// Links cards to decks with source type tracking
model PrebuiltDeckCard {
  id               String       @id @default(cuid())
  deckId           String
  deck             PrebuiltDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  cardId           String       // Unique card identifier within deck
  sourceType       String       // milestone, concept, custom, flashcard
  sourceId         String       // ID of source (milestone ID, glossary term ID, or flashcard ID)
  // Custom content (only used when sourceType is 'custom')
  customTerm       String?
  customDefinition String?
  sortOrder        Int          @default(0)

  @@unique([deckId, cardId])
  @@index([deckId])
  @@index([sourceType])
}

// =============================================================================
// Learning Paths, Checkpoints & Current Events (Sprint 37)
// =============================================================================

/// Learning path - curated sequence of milestones for structured learning
model LearningPath {
  id                   String   @id @default(cuid())
  slug                 String   @unique // URL-friendly ID (e.g., "chatgpt-story")
  title                String
  description          String
  targetAudience       String
  milestoneIds         String   @default("[]") // JSON array of milestone IDs
  estimatedMinutes     Int
  difficulty           String   // beginner, intermediate, advanced
  suggestedNextPathIds String   @default("[]") // JSON array
  keyTakeaways         String   @default("[]") // JSON array
  conceptsCovered      String   @default("[]") // JSON array
  icon                 String?  // Emoji or icon name
  sortOrder            Int      @default(0)
  isPublished          Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  checkpoints          Checkpoint[]

  @@index([slug])
  @@index([difficulty])
  @@index([isPublished])
}

/// Checkpoint - quiz/knowledge check within a learning path
model Checkpoint {
  id                String       @id @default(cuid())
  title             String
  pathId            String
  path              LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)
  afterMilestoneId  String       // Milestone ID this checkpoint follows
  questions         String       // JSON array of Question objects
  sortOrder         Int          @default(0)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([pathId])
  @@index([afterMilestoneId])
}

/// Current event - AI news connected to historical milestones
model CurrentEvent {
  id                       String    @id @default(cuid())
  headline                 String
  summary                  String
  sourceUrl                String?
  sourcePublisher          String?
  publishedDate            DateTime
  prerequisiteMilestoneIds String    @default("[]") // JSON array
  connectionExplanation    String
  featured                 Boolean   @default(false)
  expiresAt                DateTime?
  isPublished              Boolean   @default(true)
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  @@index([featured])
  @@index([publishedDate])
  @@index([isPublished])
  @@index([expiresAt])
}
